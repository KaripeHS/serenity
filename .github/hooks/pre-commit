#!/bin/sh
#
# Pre-commit hook for Serenity ERP
# CRITICAL: Prevents console statements and PHI leaks from entering repository
#

echo "üîí Running Serenity ERP pre-commit security checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

exit_code=0

# Check for console statements
echo "üîç Checking for console statements..."
console_violations=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l "console\." 2>/dev/null || true)

if [ -n "$console_violations" ]; then
    echo "${RED}‚ùå COMMIT BLOCKED: Console statements detected${NC}"
    echo "Files with violations:"
    echo "$console_violations"
    echo ""
    echo "Fix by replacing console statements with proper logging:"
    echo "  Frontend: Use loggerService from logger.service.ts"
    echo "  Backend: Use createLogger from utils/logger.ts"
    echo ""
    exit_code=1
fi

# Check for PHI patterns
echo "üè• Scanning for PHI patterns..."
phi_violations=""

# SSN patterns
ssn_check=$(git diff --cached | grep -E '\b\d{3}-\d{2}-\d{4}\b' || true)
if [ -n "$ssn_check" ]; then
    phi_violations="$phi_violations\n  - SSN patterns detected"
fi

# DOB patterns
dob_check=$(git diff --cached | grep -E '\b\d{1,2}/\d{1,2}/\d{4}\b' || true)
if [ -n "$dob_check" ]; then
    phi_violations="$phi_violations\n  - Date of birth patterns detected"
fi

# Phone patterns
phone_check=$(git diff --cached | grep -E '\b\d{3}-\d{3}-\d{4}\b' || true)
if [ -n "$phone_check" ]; then
    phi_violations="$phi_violations\n  - Phone number patterns detected"
fi

if [ -n "$phi_violations" ]; then
    echo "${RED}‚ùå COMMIT BLOCKED: Potential PHI detected${NC}"
    echo "Violations found:$phi_violations"
    echo ""
    echo "Remove PHI data or use anonymized test data"
    exit_code=1
fi

# Check for secrets
echo "üîë Checking for secrets..."
secrets_check=$(git diff --cached | grep -iE "(api_key|apikey|password.*=|secret.*=|token.*=)" | grep -v "interface\|type\|@param" || true)

if [ -n "$secrets_check" ]; then
    echo "${RED}‚ùå COMMIT BLOCKED: Potential secrets detected${NC}"
    echo "Secrets found in diff:"
    echo "$secrets_check"
    echo ""
    echo "Use environment variables for secrets"
    exit_code=1
fi

# Check for development patterns
echo "üõ†Ô∏è Checking for development patterns..."
dev_patterns=$(git diff --cached | grep -iE "(TODO|FIXME|placeholder|mock|stub|not implemented)" || true)

if [ -n "$dev_patterns" ]; then
    echo "${YELLOW}‚ö†Ô∏è  WARNING: Development patterns detected${NC}"
    echo "Found patterns:"
    echo "$dev_patterns"
    echo ""
    echo "Consider completing implementations before committing"
    # Don't block commit for warnings, just alert
fi

# TypeScript compilation check
echo "üîß Running TypeScript compilation check..."
if [ -d "frontend" ]; then
    cd frontend
    if ! npm run type-check > /dev/null 2>&1; then
        echo "${RED}‚ùå COMMIT BLOCKED: TypeScript compilation errors in frontend${NC}"
        echo "Run 'npm run type-check' to see errors"
        exit_code=1
    fi
    cd ..
fi

if [ -d "backend" ]; then
    cd backend
    if ! npx tsc --noEmit > /dev/null 2>&1; then
        echo "${RED}‚ùå COMMIT BLOCKED: TypeScript compilation errors in backend${NC}"
        echo "Run 'npx tsc --noEmit' to see errors"
        exit_code=1
    fi
    cd ..
fi

# ESLint check for frontend
if [ -d "frontend" ]; then
    echo "üîç Running ESLint checks..."
    cd frontend
    if ! npm run lint > /dev/null 2>&1; then
        echo "${RED}‚ùå COMMIT BLOCKED: ESLint errors detected${NC}"
        echo "Run 'npm run lint' to see errors"
        exit_code=1
    fi
    cd ..
fi

# Final result
if [ $exit_code -eq 0 ]; then
    echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    echo "üöÄ Commit approved for production deployment"
else
    echo ""
    echo "${RED}üíÄ COMMIT REJECTED: Security violations detected${NC}"
    echo "Fix all violations before committing"
    echo ""
    echo "For emergency commits (use sparingly):"
    echo "  git commit --no-verify -m 'emergency fix'"
fi

exit $exit_code